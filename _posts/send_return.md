---
layout: post
title: send 返回后errno设置问题探究
---
最近同事在线上碰到一个问题，就是调用send系统调用发送一段数据（send是阻塞式调用，但是设置了10s超时），没有全部发送完数据就返回，返回值为已经发送的数据，小于缓冲区需要发送的数据，但是并没有超时，errno为0，很费解。  


看到send没有发送完数据就返回，第一反应是超时，因为我之前碰到过一个类似的问题，就是因为超时导致send没有发送完数据就返回了。但是通过日志发现，这一次并没有超时。第二个反应是send在阻塞时，进程捕获到了信号，导致系统调用被中断。但是之前的理解是，如果是因为信号的缘故，那么errno会被设置为EINTR，但是在这里errno为0。同事通过观察，发现每次出现这种现象时，进程会有相应的处理信号，所以还是猜测是因为信号的原因导致send被中断。但是既然是信号中断了send调用，为什么errno为0呢？没有其他办法，只能去查内核代码，看能不能发现一点线索。  

内核中，对于tcp而言，send、sendto这些系统调用最终调用的都是tcp_sendmsg 函数。

